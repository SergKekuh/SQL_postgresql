# –ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è –≤–µ—Ä—Å–∏—è CMake
cmake_minimum_required(VERSION 3.14...3.31)

# –ù–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞
project(PostgreSQLMigrationProject LANGUAGES CXX)

# –°—Ç–∞–Ω–¥–∞—Ä—Ç C++
set(CMAKE_CXX_STANDARD 17)
set(CMAKE_CXX_STANDARD_REQUIRED ON)
set(CMAKE_CXX_EXTENSIONS OFF)

# PostgreSQL
find_package(PostgreSQL REQUIRED)

if(NOT PostgreSQL_FOUND)
    message(FATAL_ERROR "PostgreSQL not found. Please install PostgreSQL development libraries.")
endif()

# libxl
set(LIBXL_PATH ${PROJECT_SOURCE_DIR}/libxl/lib64)
set(LIBXL_INCLUDE_DIR ${PROJECT_SOURCE_DIR}/libxl/include_cpp)

if(NOT EXISTS ${LIBXL_PATH}/libxl.so AND NOT EXISTS ${LIBXL_PATH}/libxl.dll AND NOT EXISTS ${LIBXL_PATH}/libxl.lib)
    message(FATAL_ERROR "‚ö†Ô∏è libxl library not found at ${LIBXL_PATH}")
endif()

# –ü–æ–¥–∫–ª—é—á–∞–µ–º –∑–∞–≥–æ–ª–æ–≤–æ—á–Ω—ã–µ —Ñ–∞–π–ª—ã
include_directories(
    ${PROJECT_SOURCE_DIR}/include
    ${PostgreSQL_INCLUDE_DIRS}
    ${LIBXL_INCLUDE_DIR}
)

# --- –Ø–î–†–û –ü–†–û–ì–†–ê–ú–ú–´ (–±–∏–±–ª–∏–æ—Ç–µ–∫–∞) ---
set(CORE_SOURCES
    src/ClientActivity.cpp
    src/ClientStatistics.cpp
    src/Database.cpp
    src/DatabaseProcedure.cpp
    src/ExcelExporter.cpp
    src/Logger.cpp
    src/StatisticsService.cpp
    # –î–æ–±–∞–≤—å—Ç–µ –æ—Å—Ç–∞–ª—å–Ω—ã–µ —Ñ–∞–π–ª—ã
)

add_library(migration_core STATIC ${CORE_SOURCES})

target_include_directories(migration_core PUBLIC
    ${PROJECT_SOURCE_DIR}/include
)

target_link_libraries(migration_core PRIVATE
    ${PostgreSQL_LIBRARIES}
    ${LIBXL_PATH}/libxl.so
)

# --- –ò–°–ü–û–õ–ù–Ø–ï–ú–´–ô –§–ê–ô–õ MAIN ---
add_executable(main main.cpp)

target_link_libraries(main PRIVATE
    migration_core
    ${PostgreSQL_LIBRARIES}
    ${LIBXL_PATH}/libxl.so
)

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Ñ–ª–∞–≥–æ–≤ –∫–æ–º–ø–∏–ª—è—Ü–∏–∏
target_compile_options(migration_core PRIVATE
    $<$<CONFIG:Debug>:-g -Wall -Wextra -O0>
    $<$<CONFIG:Release>:-O2 -DNDEBUG>
)

target_compile_options(main PRIVATE
    $<$<CONFIG:Debug>:-g -Wall -Wextra -O0>
    $<$<CONFIG:Release>:-O2 -DNDEBUG>
)

# –¢–∏–ø —Å–±–æ—Ä–∫–∏ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
if(NOT CMAKE_BUILD_TYPE)
    set(CMAKE_BUILD_TYPE Debug CACHE STRING "Build type" FORCE)
endif()

# –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
message(STATUS "System: ${CMAKE_SYSTEM_NAME} ${CMAKE_SYSTEM_VERSION}")
message(STATUS "Compiler: ${CMAKE_CXX_COMPILER_ID} ${CMAKE_CXX_COMPILER_VERSION}")
message(STATUS "üü¢ PostgreSQL include path: ${PostgreSQL_INCLUDE_DIRS}")
message(STATUS "üü¢ PostgreSQL libraries: ${PostgreSQL_LIBRARIES}")
message(STATUS "üü¢ libxl include path: ${LIBXL_INCLUDE_DIR}")
message(STATUS "üü¢ libxl library path: ${LIBXL_PATH}")
message(STATUS "üü¢ Build type: ${CMAKE_BUILD_TYPE}")