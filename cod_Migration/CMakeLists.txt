# –ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è –≤–µ—Ä—Å–∏—è CMake
cmake_minimum_required(VERSION 3.14...3.31)

# –ù–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞
project(PostgreSQLMigrationProject)

# –°—Ç–∞–Ω–¥–∞—Ä—Ç C++
set(CMAKE_CXX_STANDARD 17)
set(CMAKE_CXX_STANDARD_REQUIRED ON)
set(CMAKE_CXX_EXTENSIONS OFF)

# PostgreSQL
find_package(PostgreSQL REQUIRED)

# GTest
find_package(GTest REQUIRED)
include_directories(${GTEST_INCLUDE_DIRS})

# –ü–æ–¥–∫–ª—é—á–∞–µ–º –∑–∞–≥–æ–ª–æ–≤–æ—á–Ω—ã–µ —Ñ–∞–π–ª—ã
include_directories(
    ${PROJECT_SOURCE_DIR}/include
    ${PostgreSQL_INCLUDE_DIRS}
    ${PROJECT_SOURCE_DIR}/libxl/include_cpp
    ${PROJECT_SOURCE_DIR}/version
    ${GTEST_INCLUDE_DIRS}
)

# –£–∫–∞–∑—ã–≤–∞–µ–º –ø—É—Ç—å –∫ libxl
set(LIBXL_PATH ${PROJECT_SOURCE_DIR}/libxl/lib64)

# --- –ì–µ–Ω–µ—Ä–∞—Ü–∏—è version.hpp –∏–∑ Git ---
add_custom_target(generate_version
    COMMAND ${PROJECT_SOURCE_DIR}/version/generate_version.sh
    WORKING_DIRECTORY ${PROJECT_SOURCE_DIR}
    BYPRODUCTS ${PROJECT_SOURCE_DIR}/version/version.hpp
    COMMENT "üîÑ –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º version.hpp –∏–∑ Git"
)

# --- –Ø–î–†–û –ü–†–û–ì–†–ê–ú–ú–´ (–±–∏–±–ª–∏–æ—Ç–µ–∫–∞) ---
file(GLOB CORE_SOURCES "src/*.cpp")
add_library(migration_core STATIC ${CORE_SOURCES})

target_include_directories(migration_core PUBLIC
    ${PROJECT_SOURCE_DIR}/include
)

target_link_libraries(migration_core PRIVATE ${PostgreSQL_LIBRARIES} ${LIBXL_PATH}/libxl.so)

# --- –ò–°–ü–û–õ–ù–Ø–ï–ú–´–ô –§–ê–ô–õ MAIN ---
add_executable(main main.cpp)
add_dependencies(main generate_version)
target_link_libraries(main PRIVATE migration_core)

# --- –ü–æ–ª—É—á–∞–µ–º –≤–µ—Ä—Å–∏—é –∏–∑ —Ñ–∞–π–ª–∞ ---
file(READ ${PROJECT_SOURCE_DIR}/version/version.hpp APP_VERSION_CONTENT)
string(REGEX MATCH "APP_VERSION \"([^\"]+)\"" _ ${APP_VERSION_CONTENT})
set(APP_VERSION ${CMAKE_MATCH_1})

# --- –ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤—ã–≤–∞–µ–º main –¥–æ —Å–±–æ—Ä–∫–∏ ---
set_target_properties(main PROPERTIES OUTPUT_NAME "main_${APP_VERSION}")

# --- –ö–æ–ø–∏—Ä—É–µ–º main –≤ –∫–æ—Ä–µ–Ω—å –ø–æ—Å–ª–µ —Å–±–æ—Ä–∫–∏ ---
add_custom_command(
    TARGET main POST_BUILD
    COMMAND ${CMAKE_COMMAND} -E copy $<TARGET_FILE:main> ${PROJECT_SOURCE_DIR}/main_${APP_VERSION}
    COMMENT "üìÅ main —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω –≤ –∫–æ—Ä–µ–Ω—å –ø—Ä–æ–µ–∫—Ç–∞ –∫–∞–∫ main_${APP_VERSION}"
)

set(CMAKE_CXX_FLAGS_DEBUG "-g -Wall -Wextra")
set(CMAKE_BUILD_TYPE Debug CACHE STRING "Build type")
set_target_properties(main PROPERTIES OUTPUT_NAME "main_debug")

# --- –¢–ï–°–¢–´ ---
enable_testing()
add_subdirectory(test)

# --- –°–¢–ê–¢–ò–ß–ï–°–ö–ò–ï –°–û–û–ë–©–ï–ù–ò–Ø ---
message(STATUS "üü¢ GTest include path: ${GTEST_INCLUDE_DIRS}")
message(STATUS "üü¢ PostgreSQL include path: ${PostgreSQL_INCLUDE_DIRS}")
message(STATUS "üü¢ PostgreSQL libraries: ${PostgreSQL_LIBRARIES}")